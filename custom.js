// Generated by CoffeeScript 1.9.1
(function() {
  var Suggestion, SuggestionView, SuggestionViews, Suggestions, hashedURLMap, user_id;

  hashedURLMap = (function() {
    var hashCode, index, isReservedKey, j, key, map, prepareURL, ref, reservedKeys, splitArr, stripParameters, strippedKey;
    map = {};
    reservedKeys = ["user_id", "timeDataSent", "version"];
    isReservedKey = function(key) {
      var i, j, ref;
      for (i = j = 0, ref = reservedKeys.length - 1; j <= ref; i = j += 1) {
        if (key === reservedKeys[i]) {
          return true;
        }
      }
      return false;
    };
    hashCode = function(str) {
      var char, hash, i, j, ref;
      hash = 0;
      if (str.length === 0) {
        return hash;
      }
      for (i = j = 0, ref = str.length - 1; j <= ref; i = j += 1) {
        char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return hash;
    };
    stripParameters = function(url) {
      return url.split("?")[0];
    };
    prepareURL = function(url) {
      var afterDomain, afterProtocol, afterSlashArr, finalURL, hash, hashedAfterDomain, hashedDomain;
      url = stripParameters(url);
      url = new URL(url);
      afterDomain = url.href.split(url.host)[1];
      hashedAfterDomain = hashCode(afterDomain);
      hashedDomain = hashCode(url.host);
      afterProtocol = url.href.split(url.protocol + "//")[1];
      afterSlashArr = afterProtocol.split("/");
      hash = "/";
      if (afterSlashArr[1]) {
        hash += hashCode(afterSlashArr.slice(1).join('/'));
      }
      finalURL = url.protocol + "//" + hashedDomain + "/" + hashedAfterDomain;
      return finalURL;
    };
    for (index = j = 0, ref = localStorage.length - 1; j <= ref; index = j += 1) {
      key = localStorage.key(index);
      if (isReservedKey(key)) {
        continue;
      }
      if (key.indexOf("chrome") === 0 || key.indexOf("file") === 0 || key.indexOf("about") === 0) {
        continue;
      }
      splitArr = key.split("/");
      splitArr.splice(-1, 1);
      strippedKey = splitArr.join("/");
      map[prepareURL(strippedKey)] = strippedKey;
    }
    return map;
  })();

  Suggestion = Backbone.Model.extend({
    initialize: function() {
      return console.log("Suggestion created!");
    }
  });

  Suggestions = Backbone.Collection.extend({
    model: Suggestion,
    id: localStorage.user_id,
    initialize: function(data) {
      var currValues, i, j, ref, results, tempSuggestion;
      results = [];
      for (i = j = 0, ref = data.length - 1; j <= ref; i = j += 1) {
        currValues = data[i];
        currValues["actualURL"] = hashedURLMap[currValues["url"]];
        tempSuggestion = new Suggestion(currValues);
        results.push(this.add(tempSuggestion));
      }
      return results;
    }
  });

  SuggestionView = Backbone.View.extend({
    model: Suggestion,
    className: 'suggestion well',
    template: _.template($("#suggestion_template").html()),
    events: {
      'click .recommend_question .yes': 'recommendYesClicked',
      'click .recommend_question .no': 'recommendNoClicked',
      'click .shared_question .yes': 'sharedYesClicked',
      'click .shared_question .no': 'sharedNoClicked'
    },
    recommendYesClicked: function() {
      console.log("Yes clicked!");
      this.sendResponse("reccomend", "yes");
      this.$el.find(".recommend_question").fadeOut();
      return this.$el.find(".shared_question").css("display", "block");
    },
    recommendNoClicked: function() {
      console.log("No clicked!");
      this.sendResponse("reccomend", "no");
      return this.$el.fadeOut();
    },
    sharedYesClicked: function() {
      console.log("Yes shared clicked");
      this.sendResponse("shared", "yes");
      return this.$el.fadeOut();
    },
    sharedNoClicked: function() {
      console.log("No shared clicked");
      this.sendResponse("shared", "no");
      return this.$el.fadeOut();
    },
    sendResponse: function(question, answer) {
      var data;
      data = this.model.attributes;
      data.question = question;
      data.answer = answer;
      return $.post("http://104.131.5.95:9292/feedback", data).done(function(response) {
        console.log("got response from feedback");
        return console.log(response);
      });
    },
    render: function() {
      this.$el.html(this.template(this.model.attributes));
      return this;
    }
  });

  SuggestionViews = Backbone.View.extend({
    el: "#suggestions_container",
    render: function() {
      var index, j, ref, results, suggestionModel, tempSuggestionView;
      console.log("suggestion views render called");
      results = [];
      for (index = j = 0, ref = this.collection.length - 1; j <= ref; index = j += 1) {
        suggestionModel = this.collection.at(index);
        console.log("in each loop");
        tempSuggestionView = new SuggestionView({
          model: suggestionModel
        });
        results.push(this.$el.append(tempSuggestionView.render().el));
      }
      return results;
    }
  });

  user_id = localStorage["user_id"];

  $.ajax("http://104.131.5.95:9292/suggested_sites/" + user_id).done(function(data) {
    var daCollection, daViews, parsedData;
    $("#loader").hide();
    parsedData = JSON.parse(data);
    daCollection = new Suggestions(parsedData);
    daViews = new SuggestionViews({
      collection: daCollection
    });
    return daViews.render();
  });

}).call(this);
